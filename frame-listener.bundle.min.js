!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("data-capsule",[],t):"object"==typeof exports?exports["data-capsule"]=t():e["data-capsule"]=t()}("undefined"!=typeof self?self:this,function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="https://static.parastorage.com/services/data-capsule/1.0.0/",r.p="undefined"!=typeof window&&window.__STATICS_BASE_URL__||r.p,r(r.s=55)}({0:function(e,t,r){"use strict";class n{constructor(){["setItem","getItem","removeItem","getAllItems"].forEach(e=>{if(this[e]===n.prototype[e])throw new Error(`BaseStorage method [${e}] must be overriden!`)})}setItem(e,t,r){throw r}getItem(e,t){throw t}removeItem(e,t){throw t}getAllItems(e){throw e}static verify(e){if(e instanceof n)return e;throw new Error("This class must extend BaseStorage!")}}e.exports=n},1:function(e,t){const r={NOT_FOUND:new Error("Key was not found in capsule"),SERVER_ERROR:new Error("Failed to perform operarion on server")};e.exports={PREFIX_SEPARATOR:"|",KEY_SEPARATOR:"#",STORAGE_PREFIX:"capsule",NOT_FOUND:r.NOT_FOUND,CONNECTION_MAX_TIMEOUT:2e3,MESSAGE_MAX_TIMEOUT:8e3,SERVER_ERROR:r.SERVER_ERROR,toError:function(e){return Object.values(r).find(t=>t.message===e)||e}}},10:function(e,t,r){e.exports=r(11)},11:function(e,t,r){"use strict";var n=r(4),o=r(3),s=function(e){return e&&e.__esModule?e:{default:e}}(r(12));var i=function(){};e.exports=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:i;if(!e||"string"!=typeof e)throw new Error("listener function expects to recieve a scope<string> as a first argument");var r=function(r){if(function(e,t){try{return(0,o.parseConnectionMessage)(e)===t}catch(e){return!1}}(r.data,e)){var i=function(e){try{return e.ports[0]}catch(e){}}(r);i&&(function(e){e.postMessage(n.connectionSuccessMsg)}(i),(0,s.default)(i,t))}};return window.addEventListener("message",r),function(){return window.removeEventListener("message",r)}}},12:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){e.onmessage=function(r){var o=r.data,s=(0,n.parseChannelMessage)(o),i=s.id,a=s.payload,c={data:a,origin:r.origin,lastEventId:r.lastEventId,source:r.source,ports:r.ports};t(c,function(t){e.postMessage((0,n.constructChannelMessage)(t,i))})}};var n=r(3)},13:function(e,t,r){"use strict";const{getCacheRecords:n,isExpired:o}=r(7);function s(e,t=e.records[0]){return localStorage.removeItem(t.originalKey),{records:t===e.records[0]?e.records.slice(1):e.records.filter(({originalKey:e})=>e!==t.originalKey),requiredSpace:e.requiredSpace-t.size}}function i(e,t){return e.lastUsed-t.lastUsed}function a(e){return e.records.length>0&&e.requiredSpace>0}e.exports=function(e){let t={records:n(),requiredSpace:e};!function(e){for(e.records.sort(i);a(e);)e=s(e)}(t=function(e){return e.records.filter(e=>o(e)).forEach(t=>e=s(e,t)),e}(t))}},3:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseConnectionMessage=t.constructConnectionMessage=t.parseChannelMessage=t.constructChannelMessage=void 0;var n=r(4);t.constructChannelMessage=function(e,t){return t?t+n.messageDelimiter+e:e},t.parseChannelMessage=function(e){var t=e.indexOf(n.messageDelimiter);return-1===t?{id:null,payload:e}:{id:e.slice(0,t),payload:e.slice(t+1)}},t.constructConnectionMessage=function(e){return n.connectionRequestMsg+n.messageDelimiter+e},t.parseConnectionMessage=function(e){var t=e.indexOf(n.messageDelimiter);if(-1===t||e.slice(0,t)!==n.connectionRequestMsg)throw new Error("Invalid connection message");return e.slice(t+1)}},4:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.connectionRequestMsg="req_con",t.connectionSuccessMsg="connection_success",t.messageDelimiter="|",t.deafultConnectionMaxTimeout=200,t.deafultMessageMaxTimeout=5e3},5:function(e,t,r){"use strict";e.exports=function(e,t,r){var n=e.split(t,r);if(n.length===r){var o=0;o="string"==typeof t?n.join(t).length:n.reduce(function(n,o,s){var i=0;return s+1<r&&(i=e.slice(n).match(t).shift().length),n+o.length+i},0),n[r-1]+=e.slice(o)}return n}},55:function(e,t,r){"use strict";const n=r(56);"undefined"!=typeof window&&(window.DataCapsuleTools=n),e.exports=n},56:function(e,t,r){"use strict";const n=r(9),o=r(6),{NOT_FOUND:s}=r(1),i=r(0),a=r(8);e.exports={NOT_FOUND:s,BaseStorage:i,DataCapsule:a,LocalStorageStrategy:o,FrameStorageListener:n}},6:function(e,t,r){"use strict";const n=r(0),o=r(13),{STORAGE_PREFIX:s,PREFIX_SEPARATOR:i,KEY_SEPARATOR:a,NOT_FOUND:c}=r(1),{getCacheRecords:u,deserializeData:l,isExpired:f}=r(7);function p(e,t){return g(t)+e}function g(e){return[s,e.namespace,e.scope].filter(e=>e).join(i)+a}function d(e,t){return JSON.stringify({lastUsed:Date.now(),createdAt:t.createdAt||Date.now(),expiration:t.expiration,value:e})}e.exports=class extends n{setItem(e,t,r){e=p(e,r),t=d(t,r);try{localStorage.setItem(e,t)}catch(r){o(e.length+t.length),localStorage.setItem(e,t)}return Promise.resolve()}getItem(e,t){const r=p(e,t);let n=localStorage.getItem(r);return(n=n&&l(n))&&!f(n)?(function(e,t){const{expiration:r,createdAt:n}=t;localStorage.setItem(e,d(t.value,{expiration:r,createdAt:n}))}(r,n),Promise.resolve(n.value)):Promise.reject(c)}removeItem(e,t){return e=p(e,t),localStorage.removeItem(e),Promise.resolve()}getAllItems(e){const t=g(e),r={};return u(t).forEach(e=>{f(e)||(r[e.key]=e.value)}),Promise.resolve(r)}}},7:function(e,t,r){"use strict";const{STORAGE_PREFIX:n,PREFIX_SEPARATOR:o,KEY_SEPARATOR:s}=r(1);function i(e){const[t,r]=e.split(s),[,n,i]=t.split(o);return void 0===i?{namespace:n,key:r}:{namespace:n,scope:i,key:r}}function a(e){return JSON.parse(e)}e.exports={deserializeData:a,getCacheRecords:function(e=n+o){const t=[];for(let r=0;r<localStorage.length;r++){const n=localStorage.key(r);if(n.startsWith(e)){const e=localStorage.getItem(n);t.push(Object.assign({size:n.length+e.length,originalKey:n},a(e),i(n)))}}return t},isExpired:function(e){return!!e.expiration&&e.createdAt+1e3*e.expiration<=Date.now()}}},8:function(e,t,r){"use strict";const n=r(0);function o(e,t){return function(e){if(!e.namespace)throw new Error("namespace is required");if("string"!=typeof e.namespace)throw new Error("namespace should be a string")}(t=Object.assign({},e,t)),t}e.exports=class extends n{constructor({strategy:e,namespace:t,scope:r}){super(),this.storageStrategy=n.verify(e),this._options={namespace:t,scope:r}}setItem(e,t,r){return r=o(this._options,r),this.storageStrategy.setItem(e,t,r)}getItem(e,t){return t=o(this._options,t),this.storageStrategy.getItem(e,t)}removeItem(e,t){return t=o(this._options,t),this.storageStrategy.removeItem(e,t)}getAllItems(e){return e=o(this._options,e),this.storageStrategy.getAllItems(e)}}},9:function(e,t,r){"use strict";const n=r(10),o=r(5),s=r(0),i=r(6);e.exports=class{constructor(e=new i){this.storageStrategy=s.verify(e),this.stopListener}start(e,t){if(!e||"function"!=typeof e)throw new Error("start function must get a verifier function as a first argument");if(t&&"function"!=typeof t)throw new Error("the interceptor must be a function");const r=s.verify(this.storageStrategy);this.stopListener=n("data-capsule",function(n,s){if("string"!=typeof n.data)return;const[i,a,c]=o(n.data,"|",3),u=(e,t)=>{if("resolve"===e){const r=[e,JSON.stringify({data:t})].join("|");return s(r)}const r=[e,t].join("|");return s(r)};if(!e(n.source,n.origin,i))return u("reject",new Error("message was not authorized"));const l=r[a].bind(r),f=JSON.parse(c).data,p=f[f.length-1],g=t?t(p,n.source,n.origin,i):p;return f[f.length-1]=g,l(...f).then(e=>u("resolve",e)).catch(e=>u("reject",e.message||e))})}stop(){this.stopListener&&this.stopListener()}}}})});
//# sourceMappingURL=frame-listener.bundle.min.js.map